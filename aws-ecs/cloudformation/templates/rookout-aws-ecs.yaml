Description: >
    This template deploys a Controller\Datastore ECS tasks exposed trough NLB \ Service Discovery or Via Public IP directly.

Parameters:

  ClusterName:
    Description: Set this value with name of existing cluster in your aws region. Othewise stack will create a new ecs cluster.
    Type: String
    Default: ""

  PrivateDNSZoneName:
    Description: Name for AWS CloudMap namespace used for service discovery
    Type: String
    Default: cluster.local
    AllowedPattern: '^[!-~]{1,1024}$'
    ConstraintDescription: Must specify a string for zone name, eg. example.local

  DefaultVPC:
    Description: Set true if you want to use default VPC or VPC without private networks.
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
    ConstraintDescription: must specify true or false.

  PublicSubnets:
    Description: Select list of public subnets for LoadBalancer and for ECS tasks in case of default vpc deployment.
    Type: 'List<AWS::EC2::Subnet::Id>'

  PrivateSubnets:
    Description: Select list of private subnets for ECS tasks. They should be in same VPC and has routes between PublicSubnets.
    Type: 'List<AWS::EC2::Subnet::Id>'

  VpcId:
    Type: 'AWS::EC2::VPC::Id'
    Description: VPC ID where resources will be deployed.

  LaunchType:
    Type: String
    Description: Launch type for ECS Services. Set to ECS if you've provided ClusterName variable with existing EC2 cluster name.
    Default: FARGATE
    AllowedValues:
      - FARGATE
      - EC2
  
  DeployController:
    Description: Set true if you want to deploy Controller service.
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
    ConstraintDescription: must specify true or false.
  
  DeployDatastore:
    Description: Set true if you want to deploy Datastore service.
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
    ConstraintDescription: must specify true or false.

  ControllerPublishLB:
    Description: Set true if you want to publish Controller service trough LoadBalancer. CreateLB parameter should be set to true or ExistingLBArn should be set.
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
    ConstraintDescription: must specify true or false.
  
  DatastorePublishLB:
    Description: Set true if you want to publish Datastore service trough LoadBalancer. CreateLB parameter should be set to true or ExistingLBArn should be set.
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
    ConstraintDescription: must specify true or false.
  
  DOPInMemoryDB:
    Description: Set true if you want to use InMemory db mode for datastore. ROOKOUT_DOP_IN_MEMORY_DB env variable will be set for datastore service.
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
    ConstraintDescription: must specify true or false.

  DOPCorsAll:
    Description: ROOKOUT_DOP_CORS_ALL env variable will be set for datastore service.
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
    ConstraintDescription: must specify true or false.

  ExistingLBArn:
    Description: Set ALB ARN if you want to use existing Application Load Balancer for chosen deployment.
    Type: String
    Default: ""
  
  CreateLB:
    Description: Set true if you want to use LoadBalancer for chosen deployment.
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
    ConstraintDescription: must specify true or false.

  ControllerServerMode:
    Description: Server mode for Controller service. CertificateS3Bucket and CertificateS3BucketPrefix will be used to download certificates in case of TLS mode.
    Type: String
    Default: "PLAIN"
    AllowedValues:
      - "PLAIN"
      - "TLS"
  
  DatastoreServerMode:
    Description: Server mode for Datastore service. CertificateS3Bucket and CertificateS3BucketPrefix will be used to download certificates in case of TLS mode.
    Type: String
    Default: "PLAIN"
    AllowedValues:
      - "PLAIN"
      - "TLS"

  ControllerCertArn:
    Type: String
    Default: ""
    Description: ACM Certificate Arn for TLS deployment of Controller service with LoadBalancer.
  
  DatastoreCertArn:
    Type: String
    Default: ""
    Description: ACM Certificate Arn for TLS deployment of datastore service with LoadBalancer.

  CertificateS3Bucket: 
    Type: String
    Default: ""
    Description: S3 bucket name where certificate files will be stored and downloaded by container task to datastore contaner volume. Automatically set datastore ROOKOUT_DOP_SERVER_MODE variable to TLS
  
  ControllerCertS3BucketPrefix:
    Type: String
    Default: ""
    Description: S3 bucket prefix (path in the bucket) where certificate files will be stored and downloaded by container task to datastore contaner volume. Can be optionally set along with CertificateS3Bucket.
  
  DatastoreCertS3BucketPrefix:
    Type: String
    Default: ""
    Description: S3 bucket prefix (path in the bucket) where certificate files will be stored and downloaded by container task to datastore contaner volume. Can be optionally set along with CertificateS3Bucket.

  Environment:
    Description: Deployment environment (dev|prod|stage).
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
      - stage
      
  TokenSecretArn:
    Description: Secret's ARN for AWS Secrets Manager secret with rookout token.
    Type: String

  ControllerContainerPort:
    Description: Controller container port to listen
    Type: String
    Default: 7488
  
  ControllerLBPort:
    Description: Controller port for Load Balancer listener
    Type: String
    Default: 7488
  
  DatastoreContainerPort:
    Description: Datastore container port to listen
    Type: String
    Default: 8080
  
  DatastoreLBPort:
    Description: Datastore port for Load Balancer listener
    Type: String
    Default: 443

  ControllerContainerCPU:
    Description: Controller container CPU requested.
    Type: String
    Default: 256

  ControllerContainerMemory:
    Description: Controller container Memory requested.
    Type: String
    Default: 512
  
  ControllerTaskCPU:
    Description: Controller task CPU requested.
    Type: String
    Default: 512

  ControllerTaskMemory:
    Description: Controller task Memory requested.
    Type: String
    Default: 1024

  DatastoreContainerCPU:
    Description: Datastore container CPU requested.
    Type: String
    Default: 256

  DatastoreContainerMemory:
    Description: Datastore container Memory requested.
    Type: String
    Default: 512
  
  DatastoreTaskCPU:
    Description: Controller task CPU requested.
    Type: String
    Default: 512

  DatastoreTaskMemory:
    Description: Controller task Memory requested.
    Type: String
    Default: 1024

  DatastoreStorageSize:
    Description: Datastore container ephermal storage size.
    Type: String
    Default: 20

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General Parameters
        Parameters:
          - Environment
          - TokenSecretArn
          - ClusterName
          - LaunchType
          - CertificateS3Bucket
      - Label:
          default: Networking
        Parameters:
          - VpcId
          - PublicSubnets
          - PrivateSubnets
          - PrivateDNSZoneName
          - CreateLB
          - ExistingLBArn
          - DefaultVPC
      - Label:
          default: Controller Parameters
        Parameters:
          - DeployController
          - ControllerPublishLB
          - ControllerServerMode
          - ControllerCertArn
          - ControllerCertS3BucketPrefix
          - ControllerContainerCPU
          - ControllerContainerMemory
          - ControllerTaskCPU
          - ControllerTaskMemory
          - ControllerContainerPort
          - ControllerLBPort
      - Label:
          default: Datastore Parameters
        Parameters:
          - DeployDatastore
          - DatastorePublishLB
          - DatastoreServerMode
          - DatastoreCertArn
          - DatastoreCertS3BucketPrefix
          - DatastoreStorageSize
          - DatastoreContainerCPU
          - DatastoreContainerMemory
          - DatastoreTaskCPU
          - DatastoreTaskMemory
          - DatastoreContainerPort
          - DatastoreLBPort
          - DOPInMemoryDB
          - DOPCorsAll

Conditions:
  DatastoreStorageIncrease: !Not [!Equals [20, !Ref DatastoreStorageSize]]
  CreateCluster: !Equals ["", !Ref ClusterName]
  PrivateTask: !Equals [false, !Ref DefaultVPC]
  DatastoreDeploy: !Equals [true, !Ref DeployDatastore]
  ControllerDeploy: !Equals [true, !Ref DeployController]
  DatastoreLBEnableTLS: !And 
    - !Not [ !Equals ["", !Ref DatastoreCertArn] ]
    - !Or
      - !Equals [true, !Ref CreateLB]
      - !Not [!Equals ["", !Ref ExistingLBArn]]
  ControllerLBEnableTLS: !And 
    - !Not [ !Equals ["", !Ref DatastoreCertArn] ]
    - !Or
      - !Equals [true, !Ref CreateLB]
      - !Not [!Equals ["", !Ref ExistingLBArn]]
  DatastoreEnableTLS: !Equals ["TLS", !Ref DatastoreServerMode]
  ControllerEnableTLS: !Equals ["TLS", !Ref ControllerServerMode]
  CreateLB: !Equals [true, !Ref CreateLB]
  NoLB: !And 
    - !Equals [false, !Ref CreateLB]
    - !Equals ["", !Ref ExistingLBArn]
  PrivateController: !And 
    - !Equals [false, !Ref ControllerPublishLB]
    - !Equals [true, !Ref DeployController]
  PrivateDatastore: !And 
    - !Equals [false, !Ref DatastorePublishLB]
    - !Equals [true, !Ref DeployDatastore]
  PublicController: !And
    - !Or
      - !Equals [true, !Ref CreateLB]
      - !Not [!Equals ["", !Ref ExistingLBArn]]
    - !Equals [true, !Ref ControllerPublishLB]
    - !Equals [true, !Ref DeployController]
  PublicDatastore: !And
    - !Or
      - !Equals [true, !Ref CreateLB]
      - !Not [!Equals ["", !Ref ExistingLBArn]]
    - !Equals [true, !Ref DatastorePublishLB]
    - !Equals [true, !Ref DeployDatastore]

Resources:

  PrivateNamespace:
    Type: AWS::ServiceDiscovery::PrivateDnsNamespace
    Properties: 
      Description: !Sub "Local cloud map namespaces for ECS cluster from CF stack ${AWS::StackName}."
      Name: !Ref PrivateDNSZoneName
      Vpc: !Ref VpcId

  ControllerServiceDiscovery:
    Condition: ControllerDeploy
    Type: AWS::ServiceDiscovery::Service
    Properties: 
      Description: Controller service discovery
      Name: !Sub 'rookout-controller-${Environment}'
      NamespaceId: !GetAtt PrivateNamespace.Id
      DnsConfig:
        RoutingPolicy: MULTIVALUE
        DnsRecords:
          - TTL: 30
            Type: A
      HealthCheckCustomConfig: 
        FailureThreshold: 1
  
  DatastoreServiceDiscovery:
    Condition: DatastoreDeploy
    Type: AWS::ServiceDiscovery::Service
    Properties: 
      Description: Datastore service discovery
      Name: !Sub 'rookout-datastore-${Environment}'
      NamespaceId: !GetAtt PrivateNamespace.Id
      DnsConfig:
        RoutingPolicy: MULTIVALUE
        DnsRecords:
          - TTL: 30
            Type: A

  EcsCluster:
    Condition: CreateCluster
    Type: AWS::ECS::Cluster

  ControllerTask:
    Condition: ControllerDeploy
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub 'rookout-controller-${Environment}-${AWS::StackName}'
      Cpu: !Ref ControllerTaskCPU
      Memory: !Ref ControllerTaskMemory
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !Ref TaskExecutionRole
      ContainerDefinitions:
        - !If
          - ControllerEnableTLS
          - Name: s3-downloader
            Image: amazon/aws-cli:latest
            Cpu: 128
            Memory: 128
            Essential: false
            Command: ["s3","sync", !Sub "s3://${CertificateS3Bucket}/${ControllerCertS3BucketPrefix}", "/var/controller-tls-secrets"]
            MountPoints:
              - ContainerPath: /var/controller-tls-secrets
                SourceVolume: certs
            LogConfiguration:
              LogDriver: awslogs
              Options:
                awslogs-group: !Ref RookoutLogGroup
                awslogs-region: !Ref AWS::Region
                awslogs-stream-prefix: !Ref DatastoreLogStream
          - !Ref 'AWS::NoValue'
        - Name: rookout-controller
          Image: rookout/controller:latest
          DependsOn:
          - !If
            - ControllerEnableTLS
            - Condition: SUCCESS
              ContainerName: s3-downloader
            - !Ref 'AWS::NoValue'
          Cpu: !Ref ControllerContainerCPU
          Memory: !Ref ControllerContainerMemory
          Essential: true
          MountPoints:
          - !If
            - ControllerEnableTLS
            - ContainerPath: /var/controller-tls-secrets
              SourceVolume: certs
            - !Ref 'AWS::NoValue'
          PortMappings:
            - ContainerPort: !Ref ControllerContainerPort
          HealthCheck:
            Command: 
            - "CMD-SHELL"
            - "wget http://localhost:4009/healthz -O /dev/null || exit 1"
            Interval: 30
            Retries: 3
            Timeout: 5
          Environment:
            - Name: ROOKOUT_DOP_NO_SSL_VERIFY
              Value: true
            - Name: ONPREM_ENABLED
              Value: true
            - Name: ROOKOUT_CONTROLLER_SERVER_MODE
              Value: !Ref ControllerServerMode
          Secrets:
            - Name: ROOKOUT_TOKEN
              ValueFrom: !Ref TokenSecretArn
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref RookoutLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: !Ref ControllerLogStream
      Volumes:
      - !If
        - ControllerEnableTLS
        - Name: certs
        - !Ref 'AWS::NoValue'
  
  DatastoreTask:
    Condition: DatastoreDeploy
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub 'rookout-datastore-${Environment}-${AWS::StackName}'
      Cpu: !Ref DatastoreTaskCPU
      Memory: !Ref DatastoreTaskMemory
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !Ref TaskExecutionRole
      EphemeralStorage: !If 
        - DatastoreStorageIncrease
        - SizeInGiB: !Ref DatastoreStorageSize
        - !Ref 'AWS::NoValue'
      ContainerDefinitions:
        - !If
          - DatastoreEnableTLS
          - Name: s3-downloader
            Image: amazon/aws-cli:latest
            Cpu: 128
            Memory: 128
            Essential: false
            Command: ["s3","sync", !Sub "s3://${CertificateS3Bucket}/${DatastoreCertS3BucketPrefix}", "/var/rookout"]
            MountPoints:
              - ContainerPath: /var/rookout
                SourceVolume: certs
            LogConfiguration:
              LogDriver: awslogs
              Options:
                awslogs-group: !Ref RookoutLogGroup
                awslogs-region: !Ref AWS::Region
                awslogs-stream-prefix: !Ref DatastoreLogStream
          - !Ref 'AWS::NoValue'
        - Name: rookout-datastore
          Image: rookout/data-on-prem:latest
          DependsOn:
          - !If
            - DatastoreEnableTLS
            - Condition: SUCCESS
              ContainerName: s3-downloader
            - !Ref 'AWS::NoValue'
          Cpu: !Ref DatastoreContainerCPU
          Memory: !Ref DatastoreContainerMemory
          Essential: true
          MountPoints:
          - !If
            - DatastoreEnableTLS
            - ContainerPath: /var/rookout
              SourceVolume: certs
            - !Ref 'AWS::NoValue'
          PortMappings:
            - ContainerPort: !Ref DatastoreContainerPort
          HealthCheck:
            Command: 
            - "CMD-SHELL"
            - "wget http://localhost:4009/healthz -O /dev/null || exit 1"
            Interval: 30
            Retries: 3
            Timeout: 5
          Environment:
            - Name: ROOKOUT_DOP_SERVER_MODE
              Value: !Ref DatastoreServerMode
            - Name: ROOKOUT_DOP_CORS_ALL
              Value: !Ref DOPCorsAll
            - Name: ROOKOUT_DOP_IN_MEMORY_DB
              Value: !Ref DOPInMemoryDB
            - Name: ROOKOUT_DOP_PORT
              Value: !Ref DatastoreContainerPort
          Secrets:
            - Name: ROOKOUT_DOP_LOGGING_TOKEN
              ValueFrom: !Ref TokenSecretArn
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref RookoutLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: !Ref DatastoreLogStream
      Volumes:
      - !If
        - DatastoreEnableTLS
        - Name: certs
        - !Ref 'AWS::NoValue'
  
  ControllerServiceLB:
    Type: AWS::ECS::Service
    Condition: PublicController
    DependsOn: ControllerALBListener
    Properties:
      Cluster: !If 
      - CreateCluster
      - !Ref EcsCluster
      - !Ref ClusterName
      LaunchType: !Ref LaunchType
      PlatformVersion: LATEST
      TaskDefinition: !Ref ControllerTask
      EnableECSManagedTags: true
      LoadBalancers:
        - ContainerName: rookout-controller
          ContainerPort: !Ref ControllerContainerPort
          TargetGroupArn: !Ref ControllerTargetGroup
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 1
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !If [ PrivateTask, DISABLED, ENABLED ] 
          Subnets: !If [ PrivateTask, !Ref PrivateSubnets, !Ref PublicSubnets ] 
          SecurityGroups:
            - !Ref ControllerSecurityGroup
      ServiceRegistries:
        - RegistryArn: !GetAtt ControllerServiceDiscovery.Arn
  
  ControllerServiceNoLB:
    Type: AWS::ECS::Service
    Condition: PrivateController
    Properties:
      Cluster: !If 
      - CreateCluster
      - !Ref EcsCluster
      - !Ref ClusterName
      LaunchType: !Ref LaunchType
      PlatformVersion: LATEST
      TaskDefinition: !Ref ControllerTask
      EnableECSManagedTags: true
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 1
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !If [ PrivateTask, DISABLED, ENABLED ] 
          Subnets: !If [ PrivateTask, !Ref PrivateSubnets, !Ref PublicSubnets ] 
          SecurityGroups:
            - !Ref ControllerSecurityGroup
      ServiceRegistries:
        - RegistryArn: !GetAtt ControllerServiceDiscovery.Arn
    
  DatastoreServiceLB:
    Type: AWS::ECS::Service
    Condition: PublicDatastore
    DependsOn: DatastoreALBListener
    Properties:
      Cluster: !If 
      - CreateCluster
      - !Ref EcsCluster
      - !Ref ClusterName
      LaunchType: FARGATE
      PlatformVersion: LATEST
      TaskDefinition: !Ref DatastoreTask
      EnableECSManagedTags: true
      LoadBalancers:
        - ContainerName: rookout-datastore
          ContainerPort: !Ref DatastoreContainerPort
          TargetGroupArn: !Ref DatastoreTargetGroup
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 1
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !If [ PrivateTask, DISABLED, ENABLED ] 
          Subnets: !If [ PrivateTask, !Ref PrivateSubnets, !Ref PublicSubnets ] 
          SecurityGroups:
            - !Ref DatastoreSecurityGroup
      ServiceRegistries:
        - RegistryArn: !GetAtt DatastoreServiceDiscovery.Arn
    
  DatastoreServiceNoLB:
    Type: AWS::ECS::Service
    Condition: PrivateDatastore
    Properties:
      Cluster: !If 
      - CreateCluster
      - !Ref EcsCluster
      - !Ref ClusterName
      LaunchType: !Ref LaunchType
      PlatformVersion: LATEST
      TaskDefinition: !Ref DatastoreTask
      EnableECSManagedTags: true
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 1
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !If [ PrivateTask, DISABLED, ENABLED ] 
          Subnets: !If [ PrivateTask, !Ref PrivateSubnets, !Ref PublicSubnets ] 
          SecurityGroups:
            - !Ref DatastoreSecurityGroup
      ServiceRegistries:
        - RegistryArn: !GetAtt DatastoreServiceDiscovery.Arn
  
  ControllerSecurityGroup:
    Condition: ControllerDeploy
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow inbound/outbound traffic for Rookout controller
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref ControllerContainerPort
          ToPort: !Ref ControllerContainerPort
          CidrIp: 0.0.0.0/0
          Description: Inbound from IGW to controller
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: 0.0.0.0/0
          Description: Outbound all

  DatastoreSecurityGroup:
    Condition: DatastoreDeploy
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow inbound/outbound traffic for Rookout datastore.
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref DatastoreContainerPort
          ToPort: !Ref DatastoreContainerPort
          CidrIp: 0.0.0.0/0
          Description: Inbound from IGW to datastore
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: 0.0.0.0/0
          Description: Outbound all
  
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: CreateLB
    Properties:
      GroupDescription: Allow inbound/outbound traffic for Rookout datastore.
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref DatastoreLBPort
          ToPort: !Ref DatastoreLBPort
          CidrIp: 0.0.0.0/0
          Description: Inbound from IGW to datastore
        - IpProtocol: tcp
          FromPort: !Ref ControllerLBPort
          ToPort: !Ref ControllerLBPort
          CidrIp: 0.0.0.0/0
          Description: Inbound from IGW to controller
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: 0.0.0.0/0
          Description: Outbound all

  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Condition: CreateLB
    Properties:         
      Scheme: internet-facing
      Subnets: !Ref PublicSubnets
      SecurityGroups: 
        - !Ref ALBSecurityGroup
      Type: application
  
  ControllerTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Condition: PublicController
    Properties:
      Port: !Ref ControllerContainerPort
      Protocol: !If [ControllerEnableTLS, "HTTPS", "HTTP"]
      VpcId: !Ref VpcId
      IpAddressType: ipv4
      TargetType: ip
  
  DatastoreTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Condition: PublicDatastore
    Properties:
      Port: !Ref DatastoreContainerPort
      Protocol: !If [DatastoreEnableTLS, "HTTPS", "HTTP"]
      VpcId: !Ref VpcId
      IpAddressType: ipv4
      HealthCheckPath: /
      TargetType: ip
  
  ControllerALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: PublicController
    Properties:
      Certificates: 
      - !If
        - ControllerLBEnableTLS
        - CertificateArn: !Ref ControllerCertArn
        - !Ref "AWS::NoValue"
      LoadBalancerArn: !If 
      - CreateLB
      - !Ref ALB
      - !Ref ExistingLBArn
      Port: !Ref ControllerLBPort
      Protocol: !If [ControllerLBEnableTLS, HTTPS, HTTP]
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ControllerTargetGroup
  
  DatastoreALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: PublicDatastore
    Properties: 
      LoadBalancerArn: !If 
      - CreateLB
      - !Ref ALB
      - !Ref ExistingLBArn
      Certificates: 
      - !If
        - DatastoreLBEnableTLS
        - CertificateArn: !Ref DatastoreCertArn
        - !Ref "AWS::NoValue"
      Port: !Ref DatastoreLBPort
      Protocol: !If [DatastoreLBEnableTLS, HTTPS, HTTP]
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref DatastoreTargetGroup
  
  LogsPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub 'rookout-logs-${Environment}-${AWS::StackName}'
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:DescribeLogStreams
              - logs:PutLogEvents
            Resource: 'arn:aws:logs:*'
      Roles:
        - !Ref TaskExecutionRole
  
  SecretsPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub 'rookout-secrets-${Environment}-${AWS::StackName}'
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
              - kms:Decrypt
            Resource: 
              - !Ref TokenSecretArn
      Roles:
        - !Ref TaskExecutionRole
    
  S3Policy:
    Type: AWS::IAM::Policy
    Condition: DatastoreEnableTLS
    Properties:
      PolicyName: !Sub 'rookout-s3-${Environment}-${AWS::StackName}'
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - s3:*
            Resource: 
              - !Sub 'arn:aws:s3:::${CertificateS3Bucket}'
              - !Sub 'arn:aws:s3:::${CertificateS3Bucket}/*'
      Roles:
        - !Ref TaskExecutionRole

  TaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ecs-tasks.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
  
  RookoutLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      RetentionInDays: 14
  
  ControllerLogStream:
    Type: AWS::Logs::LogStream
    Properties:
      LogGroupName: !Ref RookoutLogGroup
      LogStreamName: !Sub 'rookout-controller-${Environment}-${AWS::StackName}'

  DatastoreLogStream:
    Type: AWS::Logs::LogStream
    Properties:
      LogGroupName: !Ref RookoutLogGroup
      LogStreamName: !Sub 'rookout-datastore-${Environment}-${AWS::StackName}'

Outputs:

  ControllerPrivateDNS:
    Condition: ControllerDeploy
    Value: !Sub 'rookout-controller-${Environment}.${PrivateDNSZoneName}:${ControllerContainerPort}'

  DatastorePrivateDNS:
    Condition: DatastoreDeploy 
    Value: !Sub 'rookout-datastore-${Environment}.${PrivateDNSZoneName}:${DatastoreContainerPort}'
    
  LoadBalancerDNSName:
    Condition: CreateLB
    Value: !GetAtt ALB.DNSName