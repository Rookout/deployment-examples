import org.rookout.files.Utilities
import org.rookout.testsUtil.TestUtilities
def label = "worker-${UUID.randomUUID().toString()}"

pipeline {
    agent none
    stages {
        stage('Build') {
            agent any
            steps {
                    podCreator.initMain(label: label) {
        node(label) {

            container('rookout-helm') {
                githubWrapper.clone(repo: 'deployment-examples', branchToClone: 'adding-jenkins-test', workDirToRepo: "true") {
                    sh("cd ${testDir} && docker build . -t ${dockerTag} --build-arg NO_CACHE=${BUILD_TAG} && gcloud docker -- push ${dockerTag}")
                }
            }
                    }                
            }
            build_all_tests()
            }
        }
    }
}


def build_all_tests() {
    def scriptToUse = libraryResource 'generate_tests.groovy'
    println(scriptToUse)
    def testsNamesRaw = Utilities.getAllDirThatMatchFile(this, '.','Jenkinsfile')
    def testsNames = testsNamesRaw.values().toList()
    println(testsNames)
    for (int i = 0; i < testsNames.size(); i++) {
                sh "echo ${testsNames[i]}"
                TestUtilities.createTest(this, scriptToUse ,"${testsNames[i]}",  pwd() +"/${testsNames[i]}" )
    }
}