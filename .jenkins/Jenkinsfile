def label = "true".equals(env.SAME_LABEL) ? env.PROFILE : "worker-${UUID.randomUUID().toString()}"
def testDir = 'java-gradle'
def workingDir = "deployment_example/${testDir}"
def dockerTag = "us.gcr.io/rookout/deployment-example-${testDir}:latest"
podCreator.init(label: label) {
    node(label) {
        stage('Build And Push docker Image') {
            withEnv(["DOCKER_HOST=tcp://dind:2375"
                ]) {
                    container('rookout-helm') {
                        githubWrapper.clone(repo: 'deployment-examples', branchToClone: 'adding-jenkins-test', workDirToRepo: "true") {
                            sh("cd ${testDir} && docker build . -t ${dockerTag} && gcloud docker -- push ${dockerTag}")
                        }
                    }
                }
        }
    }
    stage("Background app and test"){
    def newLabel = "background-" + label
    podCreator.initRegressionTest(label: newLabel, backgroundImage: dockerTag, backgroundImageCmd: '/gradlew', backgroundImageArgs: 'jar run --project-dir=/' ) {
        node(newLabel) {
            container('rookout-helm') {
                println("hello im here")
                sh(script: "sleep 60")
                }
            }
        }
    }
}