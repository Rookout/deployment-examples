import org.rookout.files.Utilities
import org.rookout.testsUtil.TestUtilities

def label = "worker-${UUID.randomUUID().toString()}"


podCreator.initMain(label: label) {
    node(label) {
        stage('Build') {
            container('rookout-helm') {
                def myRepo = checkout scm
                def testsNamesRaw = Utilities.getAllDirThatMatchFile(this, '.', 'Jenkinsfile')
                def testsNames = testsNamesRaw.values().toList()
                println(testsNames)
                for (int i = 0; i < testsNames.size(); i++) {
                    def jobName = "${testsNames[i]}"
                    def dockerTag = "us.gcr.io/rookout/reggresion-test-${jobName}:latest"
                    sh("cd ${testDir} && docker build . -t ${dockerTag} --build-arg NO_CACHE=${BUILD_TAG} && gcloud docker -- push ${dockerTag}")
                    TestUtilities.createTest(this, scriptToUse, jobName , pwd() + "/${testsNames[i]}")
                }
            }
        }
    }
}

